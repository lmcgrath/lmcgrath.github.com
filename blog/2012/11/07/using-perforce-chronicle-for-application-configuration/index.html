
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Using Perforce Chronicle for application configuration - Logan McGrath's Blog</title>
  <meta name="author" content="Logan McGrath">

  
  <meta name="description" content="Following Paul Hammant&#8217;s post App-config workflow using SCM and subsequent proof of concept backed by Git, I will show that an app-config &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://loganmcgrath.com/blog/2012/11/07/using-perforce-chronicle-for-application-configuration/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/rss.xml" rel="alternate" title="Logan McGrath's Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-36481003-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Logan McGrath's Blog</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/rss.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:loganmcgrath.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/about-me.html">About Me</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Using Perforce Chronicle for Application Configuration</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-07T13:54:00-06:00" pubdate data-updated="true">Nov 7<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Following Paul Hammant&#8217;s post <a href="http://paulhammant.com/2012/07/10/app-config-workflow-using-scm/">App-config workflow using SCM</a> and subsequent <a href="http://paulhammant.com/2012/08/14/app-config-using-git-and-angular/">proof of concept</a> backed by Git, I will show that an app-config application backed by Perforce is possible using <a href="http://www.perforce.com/products/chronicle">Perforce Chronicle</a>.</p>

<h2>Perforce and permissions for branches</h2>

<p><a href="http://en.wikipedia.org/wiki/Perforce">Perforce</a> is an enterprise-class source control management (SCM) system, remarkably similar to Subversion (Subversion was inspired by Perforce :) Perforce is more bulletproof than Subversion in many ways and it&#8217;s generally faster. Git does not impose any security constraints or permissions on branches, Perforce gives comprehensive security options allowing you to control access to different branches: for example, development, staging, and production. Subversion, however, can support permissions on branches with some extra configuration (Apache plus mod_dav_svn/mod_dav_authz). For these reasons, Perforce is a better option for storing configuration data than either Git or Subversion.</p>

<h2>Perforce CMS as an application server</h2>

<p><a href="http://www.perforce.com/products/chronicle">Perforce Chronicle</a> is a content management system (CMS) using Perforce as the back-end store for configuration and content. The app-config application is built on top of Chronicle because Perforce does not offer a web view into the depot the way Subversion can through Apache. Branching and maintaining divergence between environments can be managed through the user interface, and Chronicle provides user authentication and management, so access between different configuration files can be restricted appropriately. The INSTALL.txt file that is distributed with Chronicle helps with an easy install, mine being set up to run locally from <code>http://localhost</code>.</p>

<p>There is a key issue in using Chronicle, however. The system is designed for the management of <em>content</em> and not necessarily arbitrary <em>files</em>. In order to make the app-config application work, I had to add a custom content type and write a module. Configuration and HTML are both plain-text content, so I created a &#8220;Plain Text&#8221; content type with the fields <em>title</em> and <em>content</em>:</p>

<ol>
<li>Go to &#8220;Manage&#8221; > &#8220;Content Types&#8221;</li>
<li>Click &#8220;Add Content Type&#8221;</li>
<li>Enter the following information:</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Id:       plaintext
</span><span class='line'>Label:    Plain Text
</span><span class='line'>Group:    Assets
</span><span class='line'>Elements:
</span><span class='line'>
</span><span class='line'>[title]
</span><span class='line'>type = text
</span><span class='line'>options.label = Title
</span><span class='line'>options.required = true
</span><span class='line'>display.tagName = h1
</span><span class='line'>display.filters.0 = HtmlSpecialChars
</span><span class='line'>
</span><span class='line'>[content]
</span><span class='line'>type = textarea
</span><span class='line'>options.label = Content
</span><span class='line'>options.required = true
</span><span class='line'>display.tagName = pre
</span><span class='line'>display.filters.0 = HtmlSpecialChars</span></code></pre></td></tr></table></div></figure>


<p>Click &#8220;Save&#8221;.</p>

<h2>The Config App</h2>

<p>I&#8217;ve borrowed heavily from Paul&#8217;s <a href="https://github.com/paul-hammant/app-config-app/blob/master/index.html">app-config HTML page</a>, which uses <a href="http://angularjs.org/">AngularJS</a> to manage the UI and interaction with the server. Where Paul&#8217;s app-config app used the <a href="http://kmkeen.com/jshon/">jshon</a> command to encode and decode JSON, Zend Framework has a utility class for encoding, decoding, and pretty-printing JSON, and Chronicle also ships with the <a href="https://github.com/paulgb/simplediff/">simplediff</a> utility for performing diffs with PHP.</p>

<p>The source JSON configuration is the same, albeit sorted:</p>

<figure class='code'><figcaption><span> (stack_configuration.json)</span> <a href='/downloads/code/app-config/stack_configuration.json'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'> <span class="nt">&quot;bannedNicks&quot;</span><span class="p">:[</span>
</span><span class='line'>  <span class="s2">&quot;derek&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;dino&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;ffff&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;jjjj&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;werwer&quot;</span>
</span><span class='line'> <span class="p">],</span>
</span><span class='line'> <span class="nt">&quot;defaultErrorReciever&quot;</span><span class="p">:</span><span class="s2">&quot;piglet@thoughtworks.com&quot;</span><span class="p">,</span>
</span><span class='line'> <span class="nt">&quot;lighton&quot;</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span>
</span><span class='line'> <span class="nt">&quot;loadMaxPercent&quot;</span><span class="p">:</span><span class="s2">&quot;88&quot;</span><span class="p">,</span>
</span><span class='line'> <span class="nt">&quot;nextShutdownDate&quot;</span><span class="p">:</span><span class="s2">&quot;8\/9\/2012&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The index.html page has been modified from the original to support only the basic <em>commit</em> and <em>diffs</em> functionality:</p>

<figure class='code'><figcaption><span> (index.html)</span> <a href='/downloads/code/app-config/index.html'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot;</span>
</span><span class='line'><span class="cp">        &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;&gt;</span>
</span><span class='line'><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span> <span class="na">xmlns:ng=</span><span class="s">&quot;http://angularjs.org&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'><span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">&quot;content-type&quot;</span> <span class="na">content=</span><span class="s">&quot;text/html; charset=UTF-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;title&gt;</span>Configuration application (alpha)<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">ng:autobind</span> <span class="na">src=</span><span class="s">&quot;http://code.angularjs.org/0.9.19/angular-0.9.19.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>  <span class="nt">&lt;style </span><span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">ins</span> <span class="p">{</span> <span class="k">color</span><span class="o">:</span> <span class="m">#00CC00</span><span class="p">;</span> <span class="k">text-decoration</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>    <span class="nt">del</span> <span class="p">{</span> <span class="k">color</span><span class="o">:</span> <span class="m">#CC0000</span><span class="p">;</span> <span class="k">text-decoration</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>  <span class="nt">&lt;/style&gt;</span>
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'><span class="nt">&lt;body</span> <span class="na">ng:controller=</span><span class="s">&quot;AppCfg&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="kd">function</span> <span class="nx">AppCfg</span><span class="p">(</span><span class="nx">$resource</span><span class="p">,</span> <span class="nx">$xhr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">newNickname</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">svrMessage</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">cfg</span> <span class="o">=</span> <span class="nx">$resource</span><span class="p">(</span><span class="s2">&quot;/appconfig/stack_configuration.json&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">({});</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">save</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">self</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">$save</span><span class="p">({</span><span class="nx">message</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">message</span><span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Config saved to server&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;ERROR on save&quot;</span><span class="p">);</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>            <span class="nx">self</span><span class="p">.</span><span class="nx">message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">newNick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">self</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">bannedNicks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">newNickname</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">self</span><span class="p">.</span><span class="nx">newNickname</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">diffs</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">$xhr</span><span class="p">(</span><span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="s2">&quot;/appconfig/diffs/stack_configuration.json&quot;</span><span class="p">,</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">toJson</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">cfg</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">svrMessage</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">self</span><span class="p">.</span><span class="nx">svrMessage</span> <span class="o">=</span> <span class="nx">svrMessage</span><span class="p">;</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="nx">deleteNick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">nick</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">oldBannedNicks</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">bannedNicks</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">self</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">bannedNicks</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>            <span class="nx">angular</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">oldBannedNicks</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">nick</span> <span class="o">!=</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">self</span><span class="p">.</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">bannedNicks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">AppCfg</span><span class="p">.</span><span class="nx">$inject</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;$resource&quot;</span><span class="p">,</span> <span class="s2">&quot;$xhr&quot;</span><span class="p">];</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>  Light is on:  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;checkbox&quot;</span> <span class="na">name=</span><span class="s">&quot;cfg.lighton&quot;</span><span class="nt">/&gt;</span> <span class="nt">&lt;br/&gt;</span>
</span><span class='line'>  Default Error Reciever (email): <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;cfg.defaultErrorReciever&quot;</span> <span class="na">ng:validate=</span><span class="s">&quot;email&quot;</span><span class="nt">/&gt;</span> <span class="nt">&lt;br/&gt;</span>
</span><span class='line'>  Max Load Percentage: <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;cfg.loadMaxPercent&quot;</span> <span class="na">ng:validate=</span><span class="s">&quot;number:0:100&quot;</span><span class="nt">/&gt;</span> <span class="nt">&lt;br/&gt;</span>
</span><span class='line'>  Next Shutdown Date: <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;cfg.nextShutdownDate&quot;</span> <span class="na">ng:validate=</span><span class="s">&quot;date&quot;</span><span class="nt">/&gt;</span> <span class="nt">&lt;br/&gt;</span>
</span><span class='line'>  Banned nicks:
</span><span class='line'>      <span class="nt">&lt;ol&gt;</span>
</span><span class='line'>        <span class="nt">&lt;li</span> <span class="na">ng:repeat=</span><span class="s">&quot;nick in cfg.bannedNicks&quot;</span><span class="nt">&gt;&lt;span&gt;</span>{{nick}} <span class="ni">&amp;nbsp;&amp;nbsp;</span><span class="nt">&lt;a</span> <span class="na">ng:click=</span><span class="s">&quot;deleteNick(nick)&quot;</span><span class="nt">&gt;</span>[X]<span class="nt">&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/ol&gt;</span>
</span><span class='line'>  <span class="nt">&lt;form</span> <span class="na">ng:submit=</span><span class="s">&quot;newNick()&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;newNickname&quot;</span> <span class="na">size=</span><span class="s">&quot;20&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;&amp;lt;-- Add Nick&quot;</span><span class="nt">/&gt;&lt;br/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/form&gt;</span>
</span><span class='line'>  <span class="nt">&lt;hr/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;button</span> <span class="na">ng:click=</span><span class="s">&quot;diffs()&quot;</span><span class="nt">&gt;</span>View Diffs<span class="nt">&lt;/button&gt;&lt;br/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;button</span> <span class="na">ng:disabled=</span><span class="s">&quot;{{!message}}&quot;</span> <span class="na">ng:click=</span><span class="s">&quot;save()&quot;</span><span class="nt">&gt;</span>Commit Changes<span class="nt">&lt;/button&gt;</span> Commit Message: <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;message&quot;</span><span class="nt">&gt;&lt;/input&gt;&lt;br/&gt;</span>
</span><span class='line'>  Last Server operation: <span class="nt">&lt;br/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">ng:bind=</span><span class="s">&quot;svrMessage | html:&#39;unsafe&#39;&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Both of these assets were added by performing:</p>

<ol>
<li>Click &#8220;Add&#8221; from the top navbar</li>
<li>Click &#8220;Add Content&#8221;</li>
<li>Select &#8220;Assets&#8221; > &#8220;Plain Text&#8221;</li>
<li>For &#8220;Title&#8221;, enter &#8220;index.html&#8221; or &#8220;stack_configuration.json&#8221;</li>
<li>Paste in the appropriate &#8220;Content&#8221;</li>
<li>Click &#8220;URL&#8221;, select &#8220;Custom&#8221;, and enter the same value as &#8220;Title&#8221; (otherwise, Chronicle will convert underscores to dashes, so be careful!)</li>
<li>Click &#8220;Save&#8221;, enter a commit message, then click the next &#8220;Save&#8221;</li>
<li>Both assets should be viewable as mangled Chronicle content entries from <code>http://localhost/index.html</code> and <code>http://localhost/stack_configuration.json</code>. <em>You normally will not use these URLs</em>.</li>
</ol>


<p>At this point, neither asset is actually usable. Most content is heavily decorated with additional HTML and then displayed within a layout template, but I want both the index.html and stack_configuration.json assets to be viewable as standalone files and provide a REST interface for AngularJS to work against.</p>

<h2>Come back PHP! All is forgiven</h2>

<p>Chronicle is largely built using <a href="http://framework.zend.com/">Zend Framework</a> and makes adding extra modules to the system pretty easy. My module needs to be able to display plaintext assets, update their content using an HTTP POST, and provide diffs between the last commit and the current content.</p>

<p>To create the module, the following paths need to be added:</p>

<ul>
<li><code>INSTALL/application/appconfig</code></li>
<li><code>INSTALL/application/appconfig/controllers</code></li>
<li><code>INSTALL/application/appconfig/views/scripts/index</code></li>
</ul>


<p>Declare the module with <code>INSTALL/application/appconfig/module.ini</code>:</p>

<figure class='code'><figcaption><span> (module.ini)</span> <a href='/downloads/code/app-config/module/module.ini'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span>
</span><span class='line'><span class="n">description</span> <span class="o">=</span> <span class="no">Application</span> <span class="n">config</span> <span class="n">proof</span> <span class="n">of</span> <span class="n">concept</span>
</span><span class='line'><span class="n">icon</span> <span class="o">=</span> <span class="n">images</span><span class="o">/</span><span class="n">icon</span><span class="o">.</span><span class="n">png</span>
</span><span class='line'><span class="n">tags</span> <span class="o">=</span> <span class="n">config</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span><span class="n">maintainer</span><span class="o">]</span>
</span><span class='line'><span class="nb">name</span> <span class="o">=</span> <span class="no">Perforce</span> <span class="no">Software</span>
</span><span class='line'><span class="n">email</span> <span class="o">=</span> <span class="n">support</span><span class="vi">@perforce</span><span class="o">.</span><span class="n">com</span>
</span><span class='line'><span class="n">url</span> <span class="o">=</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="n">www</span><span class="o">.</span><span class="n">perforce</span><span class="o">.</span><span class="n">com</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span><span class="n">routes</span><span class="o">]</span>
</span><span class='line'><span class="n">appconfig</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="no">Zend_Controller_Router_Route_Regex</span>
</span><span class='line'><span class="n">appconfig</span><span class="o">.</span><span class="n">route</span> <span class="o">=</span> <span class="s1">&#39;appconfig/(.+)&#39;</span>
</span><span class='line'><span class="n">appconfig</span><span class="o">.</span><span class="n">reverse</span> <span class="o">=</span> <span class="n">appconfig</span><span class="o">/</span><span class="sx">%s</span>
</span><span class='line'><span class="sx">appconfig.defaults.module = appconfig</span>
</span><span class='line'><span class="n">appconfig</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">controller</span> <span class="o">=</span> <span class="n">index</span>
</span><span class='line'><span class="n">appconfig</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">index</span>
</span><span class='line'><span class="n">appconfig</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">resource</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="n">appconfig</span><span class="o">-</span><span class="n">operation</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="no">Zend_Controller_Router_Route_Regex</span>
</span><span class='line'><span class="n">appconfig</span><span class="o">-</span><span class="n">operation</span><span class="o">.</span><span class="n">route</span> <span class="o">=</span> <span class="s1">&#39;appconfig/([^/]+)/(.+)&#39;</span>
</span><span class='line'><span class="n">appconfig</span><span class="o">-</span><span class="n">operation</span><span class="o">.</span><span class="n">reverse</span> <span class="o">=</span> <span class="n">appconfig</span><span class="o">/%</span><span class="n">s</span><span class="o">/</span><span class="sx">%s</span>
</span><span class='line'><span class="sx">appconfig-operation.defaults.module = appconfig</span>
</span><span class='line'><span class="n">appconfig</span><span class="o">-</span><span class="n">operation</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">controller</span> <span class="o">=</span> <span class="n">index</span>
</span><span class='line'><span class="n">appconfig</span><span class="o">-</span><span class="n">operation</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">index</span>
</span><span class='line'><span class="n">appconfig</span><span class="o">-</span><span class="n">operation</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="n">appconfig</span><span class="o">-</span><span class="n">operation</span><span class="o">.</span><span class="n">map</span><span class="o">.</span><span class="n">resource</span> <span class="o">=</span> <span class="mi">2</span>
</span></code></pre></td></tr></table></div></figure>


<p>Add a view script for displaying plaintext assets, <code>INSTALL/application/appconfig/views/scripts/index/index.phtml</code>:</p>

<figure class='code'><figcaption><span> (index.phtml)</span> <a href='/downloads/code/app-config/module/views/scripts/index/index.phtml'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entry</span><span class="o">-&gt;</span><span class="na">getValue</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">)</span> <span class="cp">?&gt;</span><span class="x"></span>
</span></code></pre></td></tr></table></div></figure>


<p>Add a view script for displaying diffs, <code>INSTALL/application/appconfig/views/scripts/index/diffs.phtml</code>:</p>

<figure class='code'><figcaption><span> (diffs.phtml)</span> <a href='/downloads/code/app-config/module/views/scripts/index/diffs.phtml'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">&lt;pre&gt;</span><span class="cp">&lt;?</span><span class="o">=</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">diffs</span> <span class="cp">?&gt;</span><span class="x">&lt;/pre&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And a controller at <code>INSTALL/application/appconfig/controllers/IndexController.phtml</code>:</p>

<figure class='code'><figcaption><span> (IndexController.php)</span> <a href='/downloads/code/app-config/module/controllers/IndexController.php'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="nb">defined</span><span class="p">(</span><span class="s1">&#39;LIBRARY_PATH&#39;</span><span class="p">)</span> <span class="k">or</span> <span class="nb">define</span><span class="p">(</span><span class="s1">&#39;LIBRARY_PATH&#39;</span><span class="p">,</span> <span class="nb">dirname</span><span class="p">(</span><span class="nx">__DIR__</span><span class="p">));</span>
</span><span class='line'><span class="k">require_once</span> <span class="nx">LIBRARY_PATH</span> <span class="o">.</span> <span class="s1">&#39;/simplediff/simplediff.php&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Appconfig_IndexController</span> <span class="k">extends</span> <span class="nx">Zend_Controller_Action</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$entry</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="nv">$mimeTypes</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>        <span class="s1">&#39;.html&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text/html&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;.json&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">preDispatch</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$request</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getRequest</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">setParams</span><span class="p">(</span><span class="nx">Url_Model_Url</span><span class="o">::</span><span class="na">fetch</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">getParam</span><span class="p">(</span><span class="s1">&#39;resource&#39;</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">getParams</span><span class="p">());</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entry</span> <span class="o">=</span> <span class="nx">P4Cms_Content</span><span class="o">::</span><span class="na">fetch</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">getParam</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;includeDeleted&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">indexAction</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getResponse</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">setHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getMimeType</span><span class="p">(),</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">view</span><span class="o">-&gt;</span><span class="na">entry</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entry</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getRequest</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">isPost</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entry</span><span class="o">-&gt;</span><span class="na">setValue</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getJsonPost</span><span class="p">());</span>
</span><span class='line'>            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entry</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getRequest</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getParam</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">function</span> <span class="nf">getMimeType</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entry</span><span class="o">-&gt;</span><span class="na">getValue</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$suffix</span> <span class="o">=</span> <span class="nx">substr</span><span class="p">(</span><span class="nv">$url</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">],</span> <span class="nb">strrpos</span><span class="p">(</span><span class="nv">$url</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">],</span> <span class="s1">&#39;.&#39;</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="nv">$suffix</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mimeTypes</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mimeTypes</span><span class="p">[</span><span class="nv">$suffix</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">diffsAction</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getResponse</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">setHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/html&#39;</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">view</span><span class="o">-&gt;</span><span class="na">diffs</span> <span class="o">=</span> <span class="nx">htmlDiff</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entry</span><span class="o">-&gt;</span><span class="na">getValue</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">),</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getJsonPost</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">function</span> <span class="nf">postDispatch</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getHelper</span><span class="p">(</span><span class="s1">&#39;layout&#39;</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">disableLayout</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">function</span> <span class="nf">getJsonPost</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getRequest</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">isPost</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prettyPrint</span><span class="p">(</span><span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">&#39;php://input&#39;</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nx">Exception</span><span class="p">(</span><span class="s1">&#39;Can\&#39;t get JSON without POST&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">function</span> <span class="nf">prettyPrint</span><span class="p">(</span><span class="nv">$json</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="nv">$array</span> <span class="o">=</span> <span class="nx">Zend_Json</span><span class="o">::</span><span class="na">decode</span><span class="p">(</span><span class="nv">$json</span><span class="p">);</span>
</span><span class='line'>        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sort</span><span class="p">(</span><span class="nv">$array</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="nx">Zend_Json</span><span class="o">::</span><span class="na">prettyPrint</span><span class="p">(</span><span class="nx">Zend_Json</span><span class="o">::</span><span class="na">encode</span><span class="p">(</span><span class="nv">$array</span><span class="p">),</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;indent&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39; &#39;</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">function</span> <span class="nf">sort</span><span class="p">(</span><span class="k">array</span> <span class="o">&amp;</span><span class="nv">$array</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nb">array_filter</span><span class="p">(</span><span class="nb">array_keys</span><span class="p">(</span><span class="nv">$array</span><span class="p">),</span> <span class="s1">&#39;is_string&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nb">ksort</span><span class="p">(</span><span class="nv">$array</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">foreach</span><span class="p">(</span><span class="nv">$array</span> <span class="k">as</span> <span class="o">&amp;</span><span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$value</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sort</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>AngularJS</h2>

<p>After all files are in place, Chronicle needs to be notified that the new module exists by going to &#8220;Manage&#8221; > &#8220;Modules&#8221;, where the &#8220;Appconfig&#8221; module will be listed if all goes well :) Both assets will now be viewable from <code>http://localhost/appconfig/index.html</code> and <code>http://localhost/appconfig/stack_configuration.json</code>. AngularJS&#8217; <a href="http://code.angularjs.org/0.9.19/docs-0.9.19/#!/api/angular.service.$resource">$resource service</a> is used in index.html to fetch stack_configuration.json and post changes back.</p>

<p>From <code>http://localhost/appconfig/index.html</code>, the data from stack_configuration.json is loaded into the form:</p>

<p><img src="/images/app-config/start.png"></p>

<p>Edits to stack_configuration.json can be made using the form, and the diffs viewed by clicking on &#8220;View Diffs&#8221;:</p>

<p><img src="/images/app-config/diffs.png"></p>

<p>The changes can be saved by entering a commit message and clicking &#8220;Commit Changes&#8221;. After which, clicking &#8220;View Diffs&#8221; will show no changes:</p>

<p><img src="/images/app-config/diffs-after-commit.png"></p>

<p>To show that edits have in fact been made to stack_configuration.json, go to <code>http://localhost/stack_configuration.json</code>, select &#8220;History&#8221; and click on &#8220;History List&#8221;:</p>

<p><img src="/images/app-config/history.png"></p>

<p>Chronicle also provides an interface for viewing diffs between revisions:</p>

<p><img src="/images/app-config/history-diffs.png"></p>

<h2>Disk Usage</h2>

<p>Something to remember in using Chronicle is that each resource requested from Perforce is written to disk before being served to the client. This means that for each request to index.html, Chronicle allocates a new Perforce workspace, checks out the associated file, serves it to the client, then deletes the file and the workspace at the end of the request. This allocate/checkout/serve/delete cycle executes for stack_configuration.json and every other resource in the system.</p>

<h2>@TODO</h2>

<h3>Security!</h3>

<p>There&#8217;s one major flaw with the appconfig module: it performs zero access checks. By default, Chronicle can be configured to disallow anonymous access by going to &#8220;Manage&#8221; > &#8220;Permissions&#8221; and deselecting all permissions for &#8220;anonymous&#8221; and &#8220;members&#8221;. Logging out and attempting to access either <code>http://localhost/appconfig/stack_configuration.json</code> or <code>http://localhost/appconfig/index.html</code> will now give an error page and prompt you to log in. Clicking &#8220;New User&#8221; will also give an error, as anonymous users don&#8217;t have the permission to create users.</p>

<p>Access rights on content are checked by the content module, but are also hard-coded in the associated controllers as IF-statements. A better solution will be required for proper access management in the appconfig module.</p>

<h3>Better integration</h3>

<p>Chronicle&#8217;s content module provides JSON integration for most of its actions, but these mostly exist to support the <a href="http://dojotoolkit.org/">Dojo Toolkit-enabled</a> front-end. Integrating with these actions over JSON requires detailed knowledge of Chronicle&#8217;s form structures.</p>

<p>Chronicle has some nice interfaces for viewing diffs. If I could call those up from index.html I would be major happy :)</p>

<h3>Automatic creation of plaintext content type</h3>

<p>Before the appconfig module is usable, the plaintext content type has to be created. I would like to automate creation of the plaintext content type when the module is first enabled.</p>

<h3>Making applications aware of updates to configuration</h3>

<p>When stack_configuration.json is updated, there&#8217;s no way to notify applications to the change, and no interface provided so they may poll for changes. I&#8217;m not entirely sure at this point what an appropriate solution would look like. In order to complete the concept, I&#8217;d first have to create a client app dependent on that configuration.</p>

<h3>Better interfaces for manipulating plaintext assets</h3>

<p>I had to fiddle with index.html quite a bit. This basically involved editing a local copy of index.html, then pasting the entire contents into the associated form in Chronicle. I have not tried checking out index.html directly from Perforce, and I imagine that any edits would need to be made within Chronicle. Github offers an in-browser raw editor, and something like that would be real handy in Chronicle.</p>

<h3>Handling conflicts</h3>

<p>There is no logic in the appconfig module to catch conflicts if there are two users editing the same file. Conflicts are detectible because an exception is thrown if there is a conflict, but I&#8217;m not sure what the workflow for resolution is in Chronicle terms, or how to integrate with it. Who wins?</p>

<h3>Working with branches</h3>

<p>I did not take the time to see how Chronicle manages branches. I will need to verify that Chronicle and the appconfig module can work with development, staging, and production branches, with maintained divergence. For example, we&#8217;re still trying to figure out how to attach visual clients like P4V to the repository and work independently of Chronicle.</p>

<h2>Kudos</h2>

<p>I would like to thank the guys at Perforce for their assistance and answering all my questions as I worked with Chronicle, especially Randy Defauw.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Logan McGrath</span></span>

      








  


<time datetime="2012-11-07T13:54:00-06:00" pubdate data-updated="true">Nov 7<span>th</span>, 2012</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://loganmcgrath.com/blog/2012/11/07/using-perforce-chronicle-for-application-configuration/" data-via="" data-counturl="http://loganmcgrath.com/blog/2012/11/07/using-perforce-chronicle-for-application-configuration/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
      
        <a class="basic-alignment right" href="/blog/2012/11/16/scm-backed-application-configuration-with-perforce/" title="Next Post: SCM-Backed Application Configuration with Perforce">SCM-Backed Application Configuration with Perforce &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/06/17/sterling-with-memoization/">Sterling With Memoization</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/16/sterling-benchmarks/">Sterling Benchmarks</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/28/promoting-changes-with-app-config-app/">Promoting changes with App-Config-App</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/20/app-config-app-in-action/">App-Config-App in Action</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/16/scm-backed-application-configuration-with-perforce/">SCM-Backed Application Configuration with Perforce</a>
      </li>
    
  </ul>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Logan McGrath -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
