<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: SCM | Logan McGrath's Blog]]></title>
  <link href="http://loganmcgrath.com/blog/categories/scm/atom.xml" rel="self"/>
  <link href="http://loganmcgrath.com/"/>
  <updated>2015-01-23T11:47:31-08:00</updated>
  <id>http://loganmcgrath.com/</id>
  <author>
    <name><![CDATA[Logan McGrath]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Promoting changes with App-Config-App]]></title>
    <link href="http://loganmcgrath.com/blog/2012/11/28/promoting-changes-with-app-config-app/"/>
    <updated>2012-11-28T13:04:00-08:00</updated>
    <id>http://loganmcgrath.com/blog/2012/11/28/promoting-changes-with-app-config-app</id>
    <content type="html"><![CDATA[<p>The App-Config-App now lets you promote changes between environments!</p>

<h2>How does it work?</h2>

<p>Perforce lets you create mappings to define the relationship between two diverging code branches. This allows for easy integration of changes between the two branches by referencing the name of the mapping.</p>

<blockquote><p>See <a href="http://www.perforce.com/perforce/doc.current/manuals/p4v/Managing_branch_specifications.html">Perforce&rsquo;s documentation</a> for more details on the how and why of branch mappings.</p></blockquote>

<p>The App-Config-App reads these branch mappings in order to create paths for promotion between environments.</p>

<h2>Promoting changes with App-Config-App</h2>

<p>The App-Config-App <code>setup_example.rb</code> creates four branches with the following mappings:</p>

<p>```</p>

<h2>Mapping        Source    Destination</h2>

<p>dev-qa         dev       qa
qa-staging     qa        staging
staging-prod   staging   prod
```</p>

<p>If you login to App-Config-App and go to &ldquo;Promote Changes,&rdquo; you get an interface showing these relationships:</p>

<p><img src="/images/app-config3/promote_changes.png"></p>

<p>Changes between environments can be promoted in either direction along a mapping configuration. The receiving environment accepts all changes (developers would know this as an &lsquo;accept-theirs&rsquo; resolution) and you are then allowed to review the changes by clicking on the &ldquo;Pending Changes&rdquo; link.</p>

<p>For example, I&rsquo;ve promoted changes from &ldquo;qa&rdquo; to &ldquo;dev&rdquo;:</p>

<p><img src="/images/app-config3/promote_result.png"></p>

<p>I can then review the changes by clicking on &ldquo;Pending Changes&rdquo;:</p>

<p><img src="/images/app-config3/pending_changes.png"></p>

<p>Changes may be edited or reverted before committing them.</p>

<h2>Promoting changes using P4V</h2>

<p><a href="http://www.perforce.com/product/components/perforce_visual_client">P4V</a> is the Perforce visual client. Using P4V, you have much greater control over how changes get promoted, but it requires a little more work.</p>

<p>I&rsquo;ve connected P4V to my App-Config-App user workspace to perform the same promotion from &ldquo;qa&rdquo; to &ldquo;dev&rdquo;:</p>

<p><img src="/images/app-config3/p4v.png"></p>

<p>Select the &ldquo;qa&rdquo; folder, then from the menu bar go to &ldquo;Actions&rdquo; > &ldquo;Merge/Integrate&rdquo;. This will bring up a wizard for performing the integration.</p>

<p>Select the following:</p>

<p><code>
Merge method: "Use branch mapping"
Branch mapping: "dev-qa"
Automatically resolve files after merging: checked
Resolve option: "Accept source"
</code></p>

<p>And ensure the direction of integration is &ldquo;Target&rdquo; &lt; &ldquo;Source&rdquo;:</p>

<p><img src="/images/app-config3/p4v_integrate.png"></p>

<p>Finally, click &ldquo;Merge&rdquo;. If you expand the &ldquo;dev&rdquo; folder, you can see the where the changes are:</p>

<p><img src="/images/app-config3/p4v_integrate_result.png"></p>

<p>You are now free to modify the files further before finally committing the changes.</p>

<h3>How it compares</h3>

<p>You get greater options when using P4V to promote changes, but producing the same result as App-Config-App&rsquo;s default behavior is fairly involved. If you aren&rsquo;t paying attention or don&rsquo;t know what you&rsquo;re doing, you might break something :(</p>

<h2>@TODO</h2>

<h3>More options for resolving changes</h3>

<p>When you promote changes in App-Config-App, the source changes will overwrite the destination. This behavior reduces the chance for a conflict to happen, but it means you really have to pay attention to what&rsquo;s changed in the destination config and possibly edit the config further before finally committing it.</p>

<h3>Conflict resolution</h3>

<p>If a conflict occurs after promoting changes, a screen should be available for viewing and editing the conflicting changes.</p>

<h3>Better error reporting if promotion fails due to permissions</h3>

<p>Users with read-only access to multiple environments will still be able to promote changes between them. The promotion doesn&rsquo;t actually occur (the files remain unchanged) but the application doesn&rsquo;t report any errors when this happens.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[App-Config-App in Action]]></title>
    <link href="http://loganmcgrath.com/blog/2012/11/20/app-config-app-in-action/"/>
    <updated>2012-11-20T07:00:00-08:00</updated>
    <id>http://loganmcgrath.com/blog/2012/11/20/app-config-app-in-action</id>
    <content type="html"><![CDATA[<p>Paul Hammant found this cool <a href="https://github.com/lmcgrath/angular-java-server-midi">Server-Side Piano</a> and I&rsquo;ve modified it to be configurable from a running App-Config-App. Because the sound is generated at the server, you&rsquo;re able to see (hear) the Server-Side Piano change its configuration without reloading the UI.</p></p>

<p><div class="embed-video-container"><iframe src="http://www.youtube.com/embed/hZbQhF6fsEo "></iframe></div></p>

<h2>Making it work for yourself</h2>

<p>I&rsquo;ve updated the <a href="https://github.com/lmcgrath/app-config-app">App-Config-App</a> with additional configuration to support choosing which instrument the Server-Side Piano will play. A clean install of App-Config-App using <code>setup_examples.rb</code> will provide everything needed to run the Server-Side Piano.</p>

<p>The application&rsquo;s configuration URL and credentials are located in <code>web.xml</code>. Additional details may be found in the application&rsquo;s <a href="https://github.com/lmcgrath/angular-java-server-midi/blob/master/README.markdown">README</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SCM-Backed Application Configuration with Perforce]]></title>
    <link href="http://loganmcgrath.com/blog/2012/11/16/scm-backed-application-configuration-with-perforce/"/>
    <updated>2012-11-16T07:00:00-08:00</updated>
    <id>http://loganmcgrath.com/blog/2012/11/16/scm-backed-application-configuration-with-perforce</id>
    <content type="html"><![CDATA[<p>Continuing from my <a href="/blog/2012/11/07/using-perforce-chronicle-for-application-configuration/">last post</a>, I&rsquo;ve <a href="https://github.com/lmcgrath/App-Config-App/">forked</a> Paul Hammant&rsquo;s original App-Config-App and modified it to work against Perforce. I&rsquo;ve decided not to continue using Perforce Chronicle as it is primarily intended for content management.</p>

<p>With this version, App-Config-App is written in Ruby, mostly using <a href="http://www.sinatrarb.com/">Sinatra</a>, a lightweight web application framework. I&rsquo;m still using <a href="http://angularjs.org/">AngularJS</a>, but I&rsquo;ve also added a few other things:</p>

<ul>
<li>A .rvmrc file, so you automagically switch to Ruby 1.9.3</li>
<li>A Gemfile, so you don&rsquo;t have to install everything individually :)</li>
<li><a href="https://github.com/sinatra/sinatra-contrib">Sinatra-Contrib</a> for view templating support</li>
<li><a href="http://nakajima.github.com/rack-flash/">Rack Flash</a> for flash messages</li>
<li><a href="http://highline.rubyforge.org/">HighLine</a> for masking passwords</li>
<li><a href="http://rubygems.org/gems/json">json</a> to manipulate JSON in native Ruby</li>
</ul>


<h2>Getting it to work.</h2>

<p>App-Config-App requires a couple things to work:</p>

<ul>
<li>Ruby 1.9.3 and Bundler</li>
<li>p4 &ndash; the Perforce command line client</li>
<li>p4d &ndash; the Perforce server</li>
</ul>


<p>All installation and example setup details may be found in <a href="https://github.com/lmcgrath/app-config-app/blob/master/README.md">App-Config-App&rsquo;s README</a>.</p>

<h2>Using App-Config-App</h2>

<p>When you login, you should see this screen:</p>

<p><img src="/images/app-config2/start.png"></p>

<p>You&rsquo;ll notice I made the extra effort to add colors and drop shadows :D The application works from the project root in Perforce, so the files in each branch are viewable here. Clicking on &ldquo;Dev&rdquo; > &ldquo;aardvark_configuration.html&rdquo; will bring up a form for editing <code>aardvark_configuration.json</code> as in the previous version:</p>

<p><img src="/images/app-config2/aardvark_configuration.png"></p>

<p>Changes to the form data are automatically saved. After making a view edits, you can click &ldquo;View Diff&rdquo; to get the diffs or &ldquo;Revert&rdquo; your changes. Go ahead and change the email address and fiddle around with the banned nicks, then go click &ldquo;Pending Changes&rdquo;:</p>

<p><img src="/images/app-config2/changes.png"></p>

<p>This screen shows all files that were changed and their diffs as well. You can &ldquo;Revert&rdquo; each file individually, and if you want to commit all changes, then enter a commit message and click &ldquo;Commit Changes&rdquo;. If you commit the changes and go back to &ldquo;Dev&rdquo; > &ldquo;aardvark_configuration.html&rdquo;, you&rsquo;ll see the new values in the form:</p>

<p><img src="/images/app-config2/aardvark_configuration-changed.png"></p>

<h2>Security and Permissions</h2>

<p>Permissions and security are managed through Perforce. For users to be able to login, they must have a user and client configured in Perforce. Those users must also have permissions configured in order to view or modify files.</p>

<p>The <code>setup_example.rb</code> script creates three test users to demonstrate branch permissions:</p>

<p>```</p>

<h2>Username        Password   Write     Read</h2>

<p>sally-runtime   bananas    prod      staging, dev
jimmy-qa        apples     staging   dev
joe-developer   oranges    dev<br/>
```</p>

<p>Logging in as any of these users will hide branches that don&rsquo;t have at least read-level access, and branches that don&rsquo;t have write-level access won&rsquo;t allow changes.</p>

<p><strong>All users created by <code>setup_example.rb</code> are intended only as examples.</strong> In the real world, all application users should be setup with real logins and real permissions.</p>

<p>It is this support for users and per-branch permissions that I am using Perforce as the SCM backend rather than Git.</p>

<h3>Application Users</h3>

<p>The <code>setup_example.rb</code> script also sets up three application users to demonstrate how an application would consume configuration:</p>

<p>```</p>

<h2>Username   Password   Read</h2>

<p>dev-app    s3cret1    dev
qa-app     s3cret2    staging
prod-app   s3cret3    prod
```</p>

<p>In theory, an application would periodically poll <a href="http://localhost:9292/dev/aardvark_configuration.md5">aardvark_configuration.md5</a> until the hash value changed, then load <a href="http://localhost:9292/dev/aardvark_configuration.json">aardvark_configuration.json</a> and reconfigure itself.</p>

<p>Application user accounts are configured in Perforce like any other user. I highly recommend that application users be given ready-only access to individual files rather than entire branches.</p>

<h2>Divergence</h2>

<p>Right now, App-Config-App offers no UI tools for managing divergence and merging. Merges must be performed outside App-Config-App, and the specific safety nets to prevent nefarious change vulnerabilities are dependent on your branch specs and permissions configuration.</p>

<p>There are also are no tools to manage conflicts of existing edits with incoming changes from another user. If a Perforce sync fails due to a conflict, you are best to revert all changes and enter them again.</p>

<h2>@TODO</h2>

<h3>A better model for autosave</h3>

<p>Autosave in AngularJS isn&rsquo;t very good. AngularJS doesn&rsquo;t integrate with DOM events the way idiomatic JavaScript does, or provide a reasonable abstraction the way Dojo Toolkit or JQuery do. Right now, autosave in App-Config-App triggers with every key press in the config forms, and pummels the back-end server with ajax posts.</p>

<p>I&rsquo;ve also noticed that the autosave triggers even when a value is invalid. The first time an email address, for example, becomes invalid, AngularJS will post back the JSON, but without the invalid email address field&mdash;the invalid field is entirely left out of the JSON structure. After that, AngularJS will stop autosaving until the value is valid. There are also no measures in place to prevent a user from leaving an invalid value and saving an incomplete JSON file.</p>

<h3>A better model for validation</h3>

<p>AngularJS does not offer a good validation API. The validation API is quite opaque and I haven&rsquo;t found any real examples using it. The built-in form validation is inadequate. There are few ng-* HTML attributes exposing more than basic configuration parameters, and no hooks offered as extension points.</p>

<p>For example, I&rsquo;m using <a href="http://docs.angularjs.org/api/ng.directive:input.text">regular expressions</a> for date validation in App-Config-App. There isn&rsquo;t a hook to provide custom validation checks, and regular expressions don&rsquo;t perform sanity checks. Values such as &ldquo;00/00/0000&rdquo; will pass validation.</p>

<h3>More example clients than the Java one needed</h3>

<p>The <a href="https://github.com/lmcgrath/app-config-java">App-Config-Java</a> client is enough to show the basic idea behind caching and reloading configuration from App-Config-App. I would like to create a few more examples in a couple different platforms, possibly also showcasing &ldquo;<a href="http://paulhammant.com/2012/07/10/app-config-workflow-using-scm/">hot reconfiguration</a>&rdquo; for feature toggles.</p>

<h3>Someone should port this to Subversion or TFS</h3>

<p>App-Config-App should be usable by the largest possible audience. For instance, if you&rsquo;re using Subversion, then you should be able to take advantage of the existing infrastructure.</p>

<p>The reason I point out Subversion and TFS is largely due to support of per-branch permissions.</p>
]]></content>
  </entry>
  
</feed>
